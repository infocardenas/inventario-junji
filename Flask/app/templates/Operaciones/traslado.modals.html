<!-- Modal de Nuevo Traslado -->
<div class="modal fade" id="trasladoModal" tabindex="-1" role="dialog" aria-labelledby="trasladoModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="trasladoModalLabel">Nuevo Traslado</h5>
                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <form id="trasladoForm">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="fechatraslado">Fecha de Traslado</label>
                        <input type="date" name="fechatraslado" id="fechatraslado" class="form-control" required>
                    </div>
                    <div class="form-group">

                        <label for="Origen">Unidad de Origen</label>

                        <div style="display: flex; align-items: center;">
                            <!--Select que muestra el codigo de la unidad al seleccionar el nombre-->
                            <select name="Origen" id="Origen" class="form-control" required
                                onchange="mostrarCodigoOrigen(event)" style="width: 60%;">

                                <option value="">Selecciona una unidad</option>

                                {% for unidad in unidades %}
                                <option value="{{ unidad.idUnidad }}" data-codigo="{{unidad.idUnidad}}">{{
                                    unidad.nombreUnidad }}</option>
                                {% endfor %}

                            </select>

                            <span style="width: 5%;"></span>

                            <!--Muestra el codigo de la unidad, según el nombre seleccionado-->
                            <input type="text" disabled id="origenCodigo" class="animated-input form-control"
                                placeholder="Código Unidad" style="width: 30%;">
                        </div>

                    </div>
                    <div class="form-group">
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <label>Equipos disponibles</label>
                            <input type="text" class="form-control " id="buscarEquipoTraslado"
                                placeholder="Buscar equipo ">
                            <table id="posts" class="table table-striped table-hover">
                                <thead class="thead-light">
                                    <tr>
                                        <th>Seleccionar</th>
                                        <th>Modelo</th>
                                        <th>Tipo Equipo</th>
                                        <th>Marca</th>
                                        <th>Código Inventario</th>
                                        <th>Número Serie</th>
                                    </tr>
                                </thead>
                                <tbody id="equiposLista">
                                    <!-- Equipos cargados dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="Destino">Unidad de Destino</label>

                        <div style="display: flex; align-items: center;">
                            <!--Select que muestra el codigo de la unidad al seleccionar el nombre-->
                            <select name="Destino" id="Destino" class="form-control" required
                                onchange="mostrarCodigoDestino(event)" style="width: 60%;">

                                <option value="">Selecciona una unidad</option>
                                {% for unidad in unidades %}
                                <option value="{{ unidad.idUnidad }}" data-codigo-2="{{unidad.idUnidad}}">{{
                                    unidad.nombreUnidad }}</option>
                                {% endfor %}
                            </select>

                            <span style="width: 5%;"></span>

                            <!--Muestra el codigo de la unidad, según el nombre seleccionado-->
                            <input type="text" disabled id="destinoCodigo" class="animated-input form-control"
                                placeholder="Código Unidad" style="width: 35%;">

                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="submit" class="btn btn-primary">Confirmar Traslado</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Detalles del Traslado -->
<div class="modal fade" id="detalleTrasladoModal" tabindex="-1" aria-labelledby="detalleTrasladoModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detalleTrasladoModalLabel">Detalles del Traslado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Fecha del Traslado:</strong> <span id="detalleFecha"></span></p>
                <p><strong>Unidad de Origen:</strong> <span id="detalleOrigen"></span></p>
                <p><strong>Unidad de Destino:</strong> <span id="detalleDestino"></span></p>

                <h5 class="mt-3">Equipos Trasladados</h5>
                <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                    <table class="table table-bordered table-sm traslado-equipos-table" style="min-width: 700px;">
                        <thead class="table-light sticky-top" style="background: #f8f9fa;">
                            <tr>
                                <th style="width: 18%;">Modelo</th>
                                <th style="width: 18%;">Tipo</th>
                                <th style="width: 18%;">Marca</th>
                                <th style="width: 23%;">Código Inventario</th>
                                <th style="width: 23%;">Número Serie</th>
                            </tr>
                        </thead>
                        <tbody id="detalleEquipos">
                            <!-- Equipos se cargarán dinámicamente aquí -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Fija el encabezado de la tabla de equipos trasladados */
    .traslado-equipos-table thead th {
        position: sticky;
        top: 0;
        background: #f8f9fa;
        z-index: 2;
    }

    .traslado-equipos-table {
        font-size: 0.95rem;
    }
</style>

<!-- Modal de editar Traslado -->
<div class="modal fade" id="editarTrasladoModal" tabindex="-1" aria-labelledby="editarTrasladoModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editarTrasladoModalLabel">Editar Traslado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Formulario para editar traslado -->
                <form id="editarTrasladoForm" method="POST" action="/traslado/edit_traslado/{{ traslado.idTraslado }}">
                    <div class="mb-3">
                        <label for="editarFechaTraslado" class="form-label">Fecha Traslado</label>
                        <input type="date" class="form-control" id="editarFechaTraslado" name="fechaTraslado" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% from 'funciones_macro.html' import paginacion, subirArchivo, tablaDocumentos %}

<!-- Modal para adjuntar PDF -->
<div class="modal fade" id="modalAdjuntarPDF" tabindex="-1" aria-labelledby="modalAdjuntarPDFLabel" aria-hidden="true">
    <!--Sección para adjuntar el archivo firmado-->
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAdjuntarPDFLabel">Firmar Traslado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <div class="modal-body">
                <form id="formAdjuntarPDF" method="POST" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="pdfFile" class="form-label">Selecciona el archivo PDF</label>
                        <input type="file" class="form-control" id="pdfFile" name="file" accept=".pdf" required>
                    </div>

                    <div class="d-grid gap-2 mt-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fa-solid fa-upload me-1"></i>
                            Subir Firma</button>
                    </div>

                </form>

                <!--Menú desplegable para mostrar detalles del traslado-->
                <div class="accordion mb-4" id="acordionDetalleTraslado">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="head">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapseDetallesTraslados" aria-expanded="false"
                                aria-controls="collapseDetallesTraslados">
                                Detalles del Traslado
                                <div class="ms-2 text text-muted">
                                    N°
                                </div>
                                <span id="detalleIdTraslado" class="text-muted"></span>
                            </button>
                        </h2>
                        <div id="collapseDetallesTraslados" class="accordion-collapse collapse"
                            data-bs-parent="#acordionDetalleTraslado" aria-labelledby="head">
                            <div class="accordion-body ">
                                <!--Tabla que muestra datos de la unidad de origen -->
                                <h6>Datos de la Unidad de Origen</h6>
                                <table class="table table-sm table-bordered tabla-detalle">
                                    <tr>
                                        <td>Unidad de Origen</td>
                                        <td id="unidadOrigen"></td>
                                    </tr>
                                    <tr>
                                        <td>Dirección</td>
                                        <td id="direccionOrigen"></td>
                                    </tr>
                                    <tr>
                                        <td> Código Unidad </td>
                                        <td id="CodigoUnidad"></td>
                                    </tr>
                                </table>
                                <!--Tabla que muestra datos de la unidad de destino-->
                                <h6>Datos de la Unidad de Destino</h6>
                                <table class="table table-sm table-bordered tabla-detalle">
                                    <tr>
                                        <td>Unidad de destino</td>
                                        <td id="unidadDestino"></td>
                                    </tr>
                                    <tr>
                                        <td>Dirección</td>
                                        <td id="direccionDestino"></td>
                                    </tr>
                                    <tr>
                                        <td>Código Unidad</td>
                                        <td id="codigoDestino"></td>
                                    </tr>
                                </table>
                                <!--Tabla que muestra los datos del equipo a transferir/trasladar-->
                                <h6>Datos del Equipo</h6>
                                <table class="table table-sm table-bordered tabla-detalle">
                                    <tr>
                                        <td>Equipo</td>
                                        <td id="nombreEquipo"></td>
                                    </tr>
                                    <tr>
                                        <td>Marca</td>
                                        <td id="marcaEquipo"></td>
                                    </tr>
                                    <td>Modelo</td>
                                    <td id="modeloEquipo"></td>
                                    </tr>
                                    <tr>
                                        <td>N° Serie</td>
                                        <td id="numeroSerie"></td>
                                    </tr>
                                    <tr>
                                        <td>Código Inventario</td>
                                        <td id="codigoInventario"></td>
                                    </tr>

                                    <tbody id="detalleEquipos">
                                        <!--Muestra los datos del equipo dinamicamente-->

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
                <!--Seccion del modal para mostrar los archivos subidos-->
                <div class="mt-3">
                    <h5>Archivos Subidos</h5>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tablaArchivosFirmados">
                            <thead>
                                <tr>
                                    <th>Nombre</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaFirmaTraslado">
                                <tr coldspan="2"></tr>
                                <!--Se cargan los archivos subidos-->
                            </tbody>
                        </table>
                    </div>

                </div>

                <!--Sección footer-->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>

                </div>
            </div>
        </div>
    </div>

    <style>
        .tabla-detalle {
            width: 100%;
            table-layout: fixed
        }

        .tabla-detalle td:first-child {
            width: 30%;
            white-space: nowrap;
            font-weight: bold;
        }

        .tabla-detalle td:last-child {
            width: 70%;
            word-break: break-word;
        }

        .accordion-body {
            margin-top: 1rem;
        }

        .accordion-item {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Buscador para la tabla de equipos en traslado
            const input = document.getElementById('buscarEquipoTraslado');
            const tbody = document.getElementById('equiposLista');
            if (input && tbody) {
                input.addEventListener('input', function () {
                    const filtro = input.value.toLowerCase();
                    Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
                        const texto = tr.textContent.toLowerCase();
                        tr.style.display = texto.includes(filtro) ? '' : 'none';
                    });
                });
            }
        });


    </script>

    <!--Script para obtener el codigo de la unidad origen-->
    <script>
        function mostrarCodigoOrigen(e) {
            //Obtiene el codigo de la variable data-codigo de las opciones del select
            let name = e.target.selectedOptions[0].getAttribute('data-codigo');
            document.getElementById('origenCodigo').value = name;
        }
    </script>
    <!--Script para obtener el codigo de la unidad destino-->
    <script>
        function mostrarCodigoDestino(e) {
            //Obtiene el codigo de la variable data-codigo de las opciones del select
            let name = e.target.selectedOptions[0].getAttribute('data-codigo-2');
            document.getElementById('destinoCodigo').value = name;
        }
    </script>